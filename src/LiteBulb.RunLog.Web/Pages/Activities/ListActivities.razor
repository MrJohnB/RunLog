@page "/activities"
@implements IDisposable
@inject HttpClient Http
@inject ApiSettings Settings
@using System.Timers
@using LiteBulb.Common.DataModel
@using LiteBulb.RunLog.Dtos
@using LiteBulb.RunLog.Web.ViewModels

<h3>Activities</h3>
<p>A list of all activities in the system</p>

@if (activities == null)
{
	<p><em>Loading...</em></p>
}
else
{
	<div class="table-responsive">
		<table class="table table-sm">
			<thead>
				<tr>
					<th>Id</th>
					<th>Athlete Name</th>
					<th>Type</th>
					<th>Status</th>
					<th>Description</th>
					<th>Units</th>
					<th>Positions</th>
					<th>Started</th>
					<th>Completed</th>
					<th><span class="invisible">View</span></th>
					<th><span class="invisible">Edit</span></th>
					<th><span class="invisible">Delete</span></th>
				</tr>
			</thead>
			<tbody>
				@foreach (var activity in activities)
				{
					<tr>
						<td>@activity.Id.ToString()</td>
						<td>@activity.AthleteName</td>
						<td>@activity.Type</td>
						<td>@activity.Status.ToString()</td>
						<td>@activity.Description</td>
						<td>@activity.Units</td>
						<td>@activity?.PositionCount</td>
						<td>@activity.StartedAt</td>
						<td>@activity.CompletedAt</td>
						<td><a class="btn btn-primary" href="/activities/@activity.Id">View</a></td>
						<td><a class="btn btn-primary" href="/activities/@activity.Id/edit">Edit</a></td>
						<td><a class="btn btn-primary" href="/activities/@activity.Id/delete">Delete</a></td>
					</tr>
				}
			</tbody>
			<tfoot>
				<tr>
					<th>Id</th>
					<th>Athlete Name</th>
					<th>Type</th>
					<th>Status</th>
					<th>Description</th>
					<th>Units</th>
					<th>Positions</th>
					<th>Started</th>
					<th>Completed</th>
					<th></th>
					<th></th>
					<th></th>
				</tr>
			</tfoot>
		</table>
	</div>
	<Pagination OnClickPaging="GetPagedResultHandler" Paging="Paging" />
}

@code {
	private PaginationViewModel Paging = new PaginationViewModel();
	private IReadOnlyCollection<ActivityDto> activities;

	private Timer timer;
	private const int timerInterval = 5000;
	void IDisposable.Dispose() => timer?.Dispose();

	protected override async Task OnInitializedAsync()
	{
		await GetPagedResultHandler(EventArgs.Empty);

		//TODO: get rid of timer on this page
		StartTimer();
	}

	private async Task<PagedResult<ActivityDto>> GetPagedResultAsync(int offset = 0, int limit = 10)
	{
		return await Http.GetFromJsonAsync<PagedResult<ActivityDto>>(Settings.ActivitiesRequestUri + $"/{offset},{limit}");
	}

	private async Task GetPagedResultHandler(EventArgs args)
	{
		var pagedResult = await GetPagedResultAsync(Paging.PageOffset, Paging.PageSize);

		activities = pagedResult.Data;
		Paging.TotalEntityCount = pagedResult.Total;
		Paging.CurrentEntityCount = Paging.TotalEntityCount - Paging.PageOffset;
		Paging.CurrentEntityIndex = (Paging.CurrentEntityCount - Paging.PageSize) > 0 ? Paging.CurrentEntityCount - Paging.PageSize + 1 : 1;
	}

	//TODO: get rid of timer
	private void StartTimer()
	{
		timer = new Timer(timerInterval);
		timer.Elapsed += TimerElapsedHandler;
		timer.Start();
		Console.WriteLine("Timer Started (List Activities).");
	}

	private async void TimerElapsedHandler(object source, ElapsedEventArgs args)
	{
		await GetPagedResultHandler(EventArgs.Empty);

		// Note that the following line is necessary because otherwise
		// Blazor would not recognize the state change and not refresh the UI
		await InvokeAsync(() => { StateHasChanged(); });

		Console.WriteLine("Timer Elapsed (List Activities).");
	}
}
@page "/activities"
@implements IDisposable
@inject HttpClient Http
@inject ApiSettings Settings
@using System.Timers
@using LiteBulb.Common.DataModel
@using LiteBulb.RunLog.Dtos

<h3>Activities</h3>
<p>A list of all activities in the system</p>

@if (activities == null)
{
	<p><em>Loading...</em></p>
}
else
{
	<div class="table-responsive">
		<table class="table table-sm">
			<thead>
				<tr>
					<th>Id</th>
					<th>Athlete Name</th>
					<th>Type</th>
					<th>Status</th>
					<th>Description</th>
					<th>Units</th>
					<th>Positions</th>
					<th>Started</th>
					<th>Completed</th>
					<th><span class="invisible">View</span></th>
					<th><span class="invisible">Edit</span></th>
					<th><span class="invisible">Delete</span></th>
				</tr>
			</thead>
			<tbody>
				@foreach (var activity in activities)
				{
					<tr>
						<td>@activity.Id.ToString()</td>
						<td>@activity.AthleteName</td>
						<td>@activity.Type</td>
						<td>@activity.Status.ToString()</td>
						<td>@activity.Description</td>
						<td>@activity.Units</td>
						<td>@activity?.PositionCount</td>
						<td>@activity.StartedAt</td>
						<td>@activity.CompletedAt</td>
						<td><a class="btn btn-primary" href="/activities/@activity.Id">View</a></td>
						<td><a class="btn btn-primary" href="/activities/@activity.Id/edit">Edit</a></td>
						<td><a class="btn btn-primary" href="/activities/@activity.Id/delete">Delete</a></td>
					</tr>
				}
			</tbody>
			<tfoot>
				<tr>
					<th>Id</th>
					<th>Athlete Name</th>
					<th>Type</th>
					<th>Status</th>
					<th>Description</th>
					<th>Units</th>
					<th>Positions</th>
					<th>Started</th>
					<th>Completed</th>
					<th></th>
					<th></th>
					<th></th>
				</tr>
			</tfoot>
		</table>
	</div>
	<div>
		<button type="button" @onclick="HandlePrevious" class="btn btn-primary oi oi-arrow-thick-left"><span class="d-none">Prev</span></button>
		<button type="button" @onclick="HandleNext" class="btn btn-primary oi oi-arrow-thick-right"><span class="d-none">Next</span></button>
		<span>Showing @currentActivityIndex to @currentActivityCount of @totalActivityCount entries</span>
	</div>
}

@code {
	private IReadOnlyCollection<ActivityDto> activities;
	private long totalActivityCount;
	private long currentActivityCount;
	private long currentActivityIndex;

	private int pageOffset = 0;
	private int pageSize = 10;

	private Timer timer;
	private const int timerInterval = 3000;
	void IDisposable.Dispose() => timer?.Dispose();

	protected override async Task OnInitializedAsync()
	{
		await GetActivitiesAsync();

		//TODO: get rid of timer on this page
		StartTimer();
	}

	private async Task GetActivitiesAsync(int offset = 0, int limit = 10)
	{
		var pagedResult = await Http.GetFromJsonAsync<PagedResult<ActivityDto>>(Settings.ActivitiesRequestUri + $"/{offset},{limit}");

		activities = pagedResult.Data;
		totalActivityCount = pagedResult.Total;
		currentActivityCount = totalActivityCount - offset;
		currentActivityIndex = (currentActivityCount - pageSize) > 0 ? currentActivityCount - pageSize + 1 : 1;
	}

	private async void HandlePrevious()
	{
		if (pageOffset - pageSize > 0)
			pageOffset -= pageSize;
		else
			pageOffset = 0;

		await GetActivitiesAsync(pageOffset, pageSize);
		await InvokeAsync(() => { StateHasChanged(); });
	}
	private async void HandleNext()
	{
		if (pageOffset + pageSize < totalActivityCount)
			pageOffset += pageSize;

		await GetActivitiesAsync(pageOffset, pageSize);
		await InvokeAsync(() => { StateHasChanged(); });
	}

	//TODO: get rid of timer
	private void StartTimer()
	{
		timer = new Timer(timerInterval);
		timer.Elapsed += TimerElapsedHandler;
		timer.Start();
		Console.WriteLine("Timer Started (List Activities).");
	}

	private async void TimerElapsedHandler(object source, ElapsedEventArgs args)
	{
		await GetActivitiesAsync(pageOffset, pageSize);

		// Note that the following line is necessary because otherwise
		// Blazor would not recognize the state change and not refresh the UI
		await InvokeAsync(() => { StateHasChanged(); });

		Console.WriteLine("Timer Elapsed (List Activities).");
	}
}